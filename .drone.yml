workspace:
    base: /data/service
    path: .

pipeline:
    test:
        image: golang:1.13.6
        commands:
            - pwd
            - go version
            - go test -v
    build:
        image: golang:1.13.6
        environment:
            - GO111MODULE=on
            - GOPROXY=https://goproxy.cn,direct
        commands:
            - go env
            - CGO_ENABLED=0 go build -o api
            - ls -l
    run:
        image: appleboy/drone-ssh
        settings:
            host:
                from_secret: host
            port: 22
            user:
                from_secret: ssh_name
            key:
                from_secret: ssh_key
        script:
            - cd /home/songwenwen/www/api && git pull origin master
            - pwd && ls -l
            - CGO_ENABLED=0 go build -o api
            - docker build -t api:v1 .
            - docker rm -f go-api || true
            - docker run -d --rm --name go-api -p 8001:8001 api:v1
    # run:
    #     image: plugins/docker
    #     path: /var/run/docker.sock
    #     script:
    #         - docker build -t api:v1 .
    #         - docker rm -f go-api || true
    #         - docker run -d --rm --name go-api -p 8001:8001 api:v1
    # docker:
    #     image: plugins/docker
    #     repo: api
    #     dockerfile: ./Dockerfile
    #     tags: v1
    #     secrets: [docker_username, docker_password]
    #     script:
    #         #- docker build -t api:v1 .
    #         - docker rm -f go-api || true # 这里这样是因为如果不存在docker-demo，rm会报错
    #         - docker run -d --rm --name go-api -p 8001:8001 api:v1
    #     # commands:
    #     #     #- ./run.sh
    #     #     - docker build -t api:v1 .
    #     #     - docker run -d --rm --name go-api -p 8001:8001 api:v1
    # deploy:
    #     image: appleboy/drone-ssh # 用于连接服务器
    #     host:
    #         - 127.0.0.1
    #     username: your_name
    #     password: your_pass
    #     port: 22
    #     command_timeout: 300 # ssh命令行执行超时时间，300秒
    #     script:
    #         - docker pull repo_url:latest
    #         - docker rm -f docker-demo || true # 这里这样是因为如果不存在docker-demo，rm会报错
    #         - docker run -d -p 8065:8065 --name docker-demo repo_url
